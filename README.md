# Усиление отказоустойчивости с помощью CoreDNS с кешем

Данное решение позволяет смягчить возможные проблемы с работой DNS сервиса при отказах в инфраструктуре с помощью CoreDNS в режиме кеширования.

## Условия для использования (Prerequisities)

* существующая папка в Облаке
* установленный инструмент [**yc**](https://cloud.yandex.ru/docs/cli/quickstart)

## Описание решения

При отказе внешних DNS серверов, решение обеспечивает DNS ответы для запросов, результаты которых был ранее закеширован.
* В процессе развертывания, в Облаке созадается виртуальная машина на базе Ubuntu 20.04, которая стандартным образом подключается к подсети.
* Внутри виртуальной машины поднимается отдельный CoreDNS в режиме кеширования.
* Штатный DNS сервис отключается. Все запросы теперь проходят через вновь установленный CoreDNS.
* В случае отказов внешних DNS-серверов CoreDNS продолжает успешно отвечать на запросы, ответы на которые ранее были закешированы.

## Использование

### Входные параметры [**variables.tf**](./variables.tf)
* `vm_name` - имя виртуальной машины в Облаке
* `vm_zone` - имя зоны доступности в Облаке

### Развертывание
1. Проверить конфигурацию рабочего окружения YC в файле [**env-yc-prod.sh**](./env-yc-prod.sh). Изменить имя профиля "prod" на нужный.
2. Активировать рабочее окружение
    ```bash
    source env-yc-prod.sh
    ```
3. Инициализировать Terraform
    ```bash
    terraform init
    ```
4. Развернуть VM с CoreDNS
    ```bash
    terraform apply
    ```

### Тестирование
1. Сохраним внешний адрес созданной VM в переменную окружения
    ```bash
    export vm_ext_ip=`terraform output vm_ext_ip_address | sed 's/"//g'`
    ```
2. Подключимся к VM
    ```bash
    ssh -oStrictHostKeyChecking=no admin@$vm_ext_ip
    ```
3. Проверим работу DNS сервиса и "прогреем" кеш CoreDNS
    ```bash
    ping www.yandex.ru
    ping github.com
    ping kubernetes.io
    ```
4. Отключим DNS сервер с помощью инструмента iptables
    ```bash
    export dns_ip=`grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" /etc/coredns/Corefile`
    sudo iptables -A OUTPUT -d $dns_ip -j DROP
    sudo iptables -L -n -v
    ```
5. Повторим проверку DNS сервиса по адресам из п.3 и убедимся, что получаем ответы
    ```bash
    ping www.yandex.ru
    ping github.com
    ping kubernetes.io    
    ```
6.  Попробуем получить IP адрес для имени, которое ранее не использовали (в DNS-кеше отсутствует) и убедимся что нам возвращется ответ "Temporary failure in name resolution".
    ```bash
    ping www.terraform.io 
    ```

### Завершение работы
```bash
unset vm_ext_ip
terraform destroy
```
